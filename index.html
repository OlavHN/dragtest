<!doctype html>
<html>
  <head>
    <title>The web!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="http://facebook.github.io/rebound-js/rebound.js"></script>
  </head>
  <body>
    <div id="draggable">Heeey!</div>
    <script>
      var draggableDiv = document.getElementById('draggable');
      var springSystem = new rebound.SpringSystem();
      var xSpring = springSystem.createSpring(50, 3);
      var ySpring = springSystem.createSpring(50, 3);
      var offset, position, time, velocity, dragging;

      xSpring.addListener({
        onSpringUpdate: function(spring) {
          if (dragging)
            return;
          position.x = spring.getCurrentValue();
          draggable.style.transform = 'translate3d(' + position.x + 'px, ' + position.y + 'px, 0)'
        }
      });

      ySpring.addListener({
        onSpringUpdate: function(spring) {
          if (dragging)
            return;
          position.y = spring.getCurrentValue();
          draggable.style.transform = 'translate3d(' + position.x + 'px, ' + position.y + 'px, 0)'
        }
      });

      function getInput(evt) {
        if ('ontouchstart' in window) {
          return {
            x: evt.changedTouches[0].clientX,
            y: evt.changedTouches[0].clientY
          };
        }
        return {
          x: evt.clientX, y: evt.clientY
        };
      }

      function start(evt) {
        evt.preventDefault();

        dragging = true;

        var input = getInput(evt);
        
        time = Date.now();

        offset = {
          x: input.x - this.getBoundingClientRect().left,
          y: input.y - this.getBoundingClientRect().top
        }

        position = {
          x: input.x - offset.x,
          y: input.y - offset.y
        };

        velocity = {
          x: 0,
          y: 0
        };

        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
        document.addEventListener('touchmove', move);
        document.addEventListener('touchend', end);
      }

      function move(evt) {
        var input = getInput(evt);

        var newPos = {
          x: input.x - offset.x,
          y: input.y - offset.y
        };

        var dPos = {
          x: newPos.x - position.x,
          y: newPos.y - position.y
        };

        var newTime = Date.now();

        velocity = {
          x: 1000 * dPos.x / (newTime - time),
          y: 1000 * dPos.y / (newTime - time)
        };

        time = newTime;

        position = {
          x: newPos.x,
          y: newPos.y
        };

        draggable.style.transform = 'translate3d(' + position.x + 'px, ' + position.y + 'px, 0)'
      }

      function end(evt) {
        dragging = false;

        xSpring
          .setCurrentValue(position.x)
          .setVelocity(velocity.x) 
          .setEndValue(Math.max(0, Math.min(window.innerWidth, position.x + velocity.x * 0.5)));

        ySpring
          .setCurrentValue(position.y)
          .setVelocity(velocity.y) 
          .setEndValue(Math.max(0, Math.min(window.innerWidth, position.y + velocity.y * 0.5)));

        draggable.style.transform = 'translate3d(' + position.x + 'px, ' + position.y + 'px, 0)'

        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', end);
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', end);
      }

      draggable.addEventListener('mousedown', start);
      draggable.addEventListener('touchstart', start);
    </script>
  </body>
</html>